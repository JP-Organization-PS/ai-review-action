# .github/workflows/reusable-review.yml
# This is the central, reusable workflow that contains the main logic.

name: Reusable AI Code Review

# Define the permissions this workflow needs to operate on the calling repository.
permissions:
  contents: read
  pull-requests: write

# This makes the workflow callable from other workflows.
on:
  workflow_call:
    # Define inputs that the calling workflow can provide.
    inputs:
      ai-model:
        description: 'The AI model to use (gemini or azure)'
        required: false
        type: string
        default: 'gemini'
    # Define the secrets this workflow needs. The calling workflow must provide them.
    secrets:
      GEMINI_API_KEY:
        required: false
      AZURE_OPENAI_KEY:
        required: false
      AZURE_OPENAI_ENDPOINT:
        required: false
      AZURE_OPENAI_DEPLOYMENT:
        required: false

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code of the Calling Repository
        uses: actions/checkout@v4
        with:
          # Required to get the full commit history for an accurate diff.
          fetch-depth: 0

      - name: Checkout AI Review Action Repo
        uses: actions/checkout@v4
        with:
          repository: JP-Organization-PS/ai-review-action
          # Checkout the action to a clean, top-level directory
          path: ./ai-review-action-repo

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install AI Review Dependencies
        # Set the working directory to the action's checkout path
        working-directory: ./ai-review-action-repo
        run: |
          npm install axios@^1.7.2 @actions/github@^6.0.0 parse-diff@^0.11.1 string-similarity@^4.0.4 --legacy-peer-deps
          npm install tree-sitter@^0.20.8 --legacy-peer-deps
          npm install tree-sitter-javascript@^0.20.1 tree-sitter-typescript@^0.20.3 tree-sitter-python@^0.20.5 tree-sitter-java@^0.20.2 tree-sitter-c-sharp@^0.20.0 tree-sitter-go@^0.20.0 tree-sitter-rust@^0.20.5 tree-sitter-php@^0.20.0 tree-sitter-ruby@^0.20.0 tree-sitter-c@^0.20.0 tree-sitter-cpp@^0.20.1 --legacy-peer-deps

      - name: Run AI Code Review
        env:
          AI_MODEL: ${{ inputs.ai-model }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
        run: node ./ai-review-action-repo/.github/scripts/ai-review.js